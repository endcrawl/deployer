#!/bin/sh

usage() { echo "usage: ${0##*/} <unit> <revision> [<program>]"; }

main()
{
  if [ $# -lt 2 ]; then
    usage 1>&2
    exit 100
  fi

  unit="$1"        ; shift
  revision="$1"    ; shift

  # Validate unit and revision against unsafe path chars.

  for a in "$unit" "$revision"; do
    test -z "$a"            && barf "missing unit or revision"
    test "$a" != "${a##*.}" && barf "invalid unit or revision: $a"
    test "$a" != "${a##*/}" && barf "invalid unit or revision: $a"
  done

  # Validate config we use.

  test -z "$DEPLOYER_DATA_DIR"    && barf "missing environment variable: DEPLOYER_DATA_DIR"
  test -z "$DEPLOYER_DEPLOY_ROOT" && barf "missing environment variable: DEPLOYER_DEPLOY_ROOT"
  test -d "$DEPLOYER_DEPLOY_ROOT" || barf "deploy root directory missing: $DEPLOYER_DEPLOY_ROOT"

  # Verify that the unit is actually a managed deployment.

  test ! -d "${DEPLOYER_DATA_DIR}/${unit}" && barf "unit is unmanaged: ${unit}"

  # Self-exec to put per-unit settings in environment, unless we've already done that.

  test "$unit" = "$DEPLOYER_UNIT" || safe exec envdir "${DEPLOYER_DATA_DIR}/${unit}" "$0" "$unit" "$revision" "$@"

  # In privileged mode, some per-unit settings are required.

  if [ `id -u` -eq 0 ]; then
    test -z "$DEPLOYER_USER"  && barf "missing required per-unit setting in privileged mode: DEPLOYER_USER"
  fi

  # Load any per-unit ssh-key and make it accessible.

  if [ -n "$DEPLOYER_SSH_KEY" ]; then
    test -n "$SSH_AUTH_SOCK" || safe exec ssh-agent "$0" "$unit" "$revision" "$@"
    safe ssh-add "$DEPLOYER_SSH_KEY"
    if [ `id -u` -eq 0 ]; then
      safe chmod g+w "$SSH_AUTH_SOCK"
      safe envuidgid "$DEPLOYER_USER" sh -c 'exec chgrp "$GID" "$1"' -- "$SSH_AUTH_SOCK"
    fi
  fi

  # Run the "bottom half" of this operation. Drop privileges in privileged mode.

  if [ `id -u` -eq 0 ]; then
    target_new=`setuidgid -s "$DEPLOYER_USER" deployer-update "$unit" "$revision" "$@"`
    rc=$?
  else
    target_new=`deployer-update "$unit" "$revision" "$@"`
    rc=$?
  fi
  test $rc -eq 0 || exit $rc

  # Create the new symlink under the .tmp/ dir.

  safe ln -s "$target_new" "${DEPLOYER_DEPLOY_ROOT}/.tmp/${unit}"

  # Atomically move the new symlink into place.

  (
    safe cd "${DEPLOYER_DEPLOY_ROOT}/.tmp"
    safe mv "$unit" ..
  )
  rc="$?" ; if [ "$rc" -ne 0 ]; then return "$rc"; fi

  log 2 "switched active checkout to: ${target_new}"

  return 0
}

. shellsafe || { echo "error sourcing shellsafe." 1>&2 ; exit 100 ; }
main "$@"
exit $?

