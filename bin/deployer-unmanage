#!/bin/sh

usage() { echo "usage: ${0##*/} <unit>"; }

main()
{
  if [ $# -lt 1 ]; then
    usage 1>&2
    exit 100
  fi

  unit="$1" ; shift

  test -z "$unit"                 && barf "missing unit"
  test "$unit" != "${unit##*.}"   && barf "invalid unit: $unit"
  test "$unit" != "${unit##*/}"   && barf "invalid unit: $unit"
  test -z "$DEPLOYER_DEPLOY_ROOT" && barf "missing environment variable: DEPLOYER_DEPLOY_ROOT"
  test -d "$DEPLOYER_DEPLOY_ROOT" || barf "deploy root directory missing: $DEPLOYER_DEPLOY_ROOT"
  test -z "$DEPLOYER_QUEUE"       && barf "missing environment variable: DEPLOYER_QUEUE"
  test -d "$DEPLOYER_QUEUE"       || barf "deploy root directory missing: $DEPLOYER_QUEUE"
  test -z "$DEPLOYER_DATA_DIR"    && barf "missing environment variable: DEPLOYER_DATA_DIR"
  test -d "$DEPLOYER_DATA_DIR"    || barf "deploy data directory missing: $DEPLOYER_DATA_DIR"

  # Remove the per-unit directory for incoming deployer job requests.

  safe rm -rf "${DEPLOYER_QUEUE}/req/${unit}"

  # Remove the per-unit directory for settings.

  safe rm -rf "${DEPLOYER_DATA_DIR}/${unit}"

  # Remove the active symlink.

  symlink="$DEPLOYER_DEPLOY_ROOT/${unit}"
  test -L "$symlink" && safe rm "$symlink"

  # Remove both foo.a/ and foo.b/ directories.

  for suffix in a b; do
    dir="$DEPLOYER_DEPLOY_ROOT/${unit}.${suffix}"
    test -d "$dir" && rm -rf "$dir"
  done

  return 0
}

. shellsafe || { echo "error sourcing shellsafe." 1>&2 ; exit 100 ; }
main "$@"
exit $?

